# 1. Dùng Tomcat 9 chính thức
FROM tomcat:9.0

# 2. Xóa webapps mặc định
RUN rm -rf /usr/local/tomcat/webapps/*

# 3. Copy WAR vào ROOT.war
COPY dist/web.war /usr/local/tomcat/webapps/ROOT.war

# 4. Tạo script start.sh patch port runtime
RUN echo '#!/bin/bash\n\
echo "Render PORT = ${PORT}"\n\
# Patch server.xml để Tomcat lắng nghe port Render cung cấp\n\
sed -i "s/port=\"8080\"/port=\"${PORT}\"/" /usr/local/tomcat/conf/server.xml\n\
# Start Tomcat\n\
catalina.sh run' > /start.sh \
    && chmod +x /start.sh

# 5. Expose placeholder port để Render detect
EXPOSE 8080

# 6. ENTRYPOINT chạy script start.sh
ENTRYPOINT ["/start.sh"]


